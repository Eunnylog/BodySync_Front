<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’ªBodySync ë¡œê·¸ì¸ ì²˜ë¦¬ì¤‘ ....</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
        crossorigin="anonymous"></script>
</head>

<body>
    <!-- Toast -->
    <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1081;">
        <div id="common-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="3000">
            <div class="toast-header">
                <strong class="me-auto" id="common-toast-title">ì•Œë¦¼</strong>
                <small>ë°©ê¸ˆ ì „</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="common-toast-body">
            </div>
        </div>
    </div>
    <p>ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
    <script>
        // const backend_base_url = 'http://localhost:8000'
        const backend_base_url = "https://api.body-sync.shop"
        let commonToastInstance;

        document.addEventListener('DOMContentLoaded', async function () {
            const toastElement = document.getElementById('common-toast')
            if (toastElement) {
                commonToastInstance = new bootstrap.Toast(toastElement)
            }


            const urlParams = new URLSearchParams(window.location.search)
            const code = urlParams.get('code')

            if (code) {
                try {
                    const response = await fetch(`${backend_base_url}/users/kakao/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify({ 'code': code })
                    });
                    console.log(response.status)
                    if (response.status === 200) {
                        showToast('ë¡œê·¸ì¸ ì„±ê³µ! í™˜ì˜í•©ë‹ˆë‹¤!', 'success')
                        const response_json = await response.json()
                        localStorage.setItem('payload', JSON.stringify(response_json.payload))
                        setTimeout(function () {
                            window.location.href = 'index.html'
                        }, 1500)
                    } else {
                        const errorData = await response.json()
                        let errorMessage = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'

                        console.error('ë¡œê·¸ì¸ API ì‹¤íŒ¨:', response.status, errorData)

                        if (response.status === 401) {
                            if (errorData && (errorData.code === 'user_inactive' || errorData.code === 'user_inactive_account' || errorData.code === 'user_inactive_account_custom')) {
                                errorMessage = "íƒˆí‡´ëœ ê³„ì •ì…ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ë‹¤ì‹œ íšŒì›ê°€ì…í•´ ì£¼ì„¸ìš”."
                            } else if (errorData && errorData.detail) {
                                errorMessage = "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ ì£¼ì„¸ìš”."
                            }
                        } else if (response.status === 400) {
                            if (typeof errorData === 'object' && errorData !== null) {
                                errorMessage = Object.values(errorData).flat().join('\n') || errorMessage;
                            }
                        } else {
                            errorMessage = `ì„œë²„ ì˜¤ë¥˜ (${response.status}): ${errorData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì œ'}`
                        }

                        showToast(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${errorMessage}`, 'danger', 'ì˜¤ë¥˜')
                        // setTimeout(() => {
                        //     window.location.href = '/index.html';
                        // }, 2000);
                    }
                } catch (error) {
                    console.error('ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error)
                    showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'danger', 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜')
                    // setTimeout(() => {
                    //     window.location.href = '/index.html'
                    // }, 2000);
                }
            } else {
                console.warn('ì¸ê°€ ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ íë¦„ì— ë¬¸ì œê°€ ìˆê±°ë‚˜ ì‚¬ìš©ìê°€ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.')
                showToast('ë¡œê·¸ì¸ì— í•„ìš”í•œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning', 'ë¡œê·¸ì¸ ì˜¤ë¥˜')
                // setTimeout(() => {
                //     window.location.href = '/index.html'
                // }, 2000);
            }
        });


        // Toast
        function showToast(message, type = 'info', title = 'ì•Œë¦¼') {
            if (!commonToastInstance) {
                console.log('Toast Error')
                return
            }

            const toastElement = commonToastInstance._element

            toastElement.classList.remove('text-bg-success', 'text-bg-danger', 'text-bg-warning', 'text-bg-info')

            if (type !== 'info') {
                toastElement.classList.add(`text-bg-${type}`)
            }

            document.getElementById('common-toast-title').innerText = title
            document.getElementById('common-toast-body').innerText = message

            commonToastInstance.show()
        }
    </script>
</body>

</html>